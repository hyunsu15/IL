# 요약
- 디버깅을 통해서 문제점 발견함.
- 스프링 인터셉터를 통해서 해당 문제를 해결함.
- 생각보다 사이트 속도가 빨라짐.

## 문제 상황
JWT 리프레쉬 토큰으로 액세스 토큰을 재발급 될 때마다 사이트가 느려졌음. 그리고 먹통이 되는 이슈가 생겼습니다.

해당 문제를 인지하게 되어, 디버깅을 통해 문제점에 대해 알아보게 되었습니다.

우선 팀원이 작성했던 코드는 다음과 같은 흐름이었습니다.

- FEIGN 클라이언트가 요청을 보내기 전에 RequestInterceptor라는 것을 통하여 쿠키에 있는 엑세스 토큰을 넣어서 보내준다.

- 이 요청에서 401이면서 재발급 관련 요청에서 실패한거면, 재발급 로직을 타고 다시 처음부터 다시 시도.

이러한 방식으로 문제 해결 하고 있었다.

논리상으로는 엄청 문제가 되지 않았다.

## 하지만 내부 구현을 보니 예상과 다르게 움직였다.

아마 팀원이 짠 흐름을 다음을 기대했던 것 같다.

- 처음 요청에선 실패하여 재발급이 되고, 재시도 한다.
- 그 이후 요청들은 재발급된 액세스토큰을 기반으로 재발급 로직이 타면 안되고 나머지 로직들은 정상적인 작동한다.

하지만 디버깅을 해본 결과는 달랐다.

- feign 요청을 보내기전에 모두 만료된 액세스토큰을 넣는다.
- 그래서 모든 요청은 실패 처리되고, 모든 feign 요청 재발급을 시도하며, 재시도를 한다.

이러면서 원치않은 많은 액세스 토큰이 만들어지고, 리프레쉬 토큰도 갱신된다. 아마 로직이 꼬인 느낌을 받았다.

## 문제 해결은 인터셉터를 사용했다.

모든 feign클라이언트 requestInterceptor가 타기전 재발급이 필요한 시점에 재발급을 해주면 되지 않을까 라는 생각했다. 이 문제를 인터셉터를 통해 해결했다.

액세스토큰이 없고, 리프레쉬 토큰이 있는 경우에는 미리 재발급을 하게끔 만들었다.

그리고 추후 개선사항으로 리프레쉬토큰이 쿠키로 남아있지만, 서버에서 인지를 못하는 경우에는 로직을 추가하여, 다시 로그인하게끔 변경했습니다.

## 얻은 효과

생각보다 사이트 응답 속도가 빨라짐.
- 개선버전에서 응답속도가 빨라졌다. 아마 불필요한 retry 호출이 줄어들어서 빨라진 것으로 추정됨.


## 관련 링크

[문제해결했던 커밋기록](https://github.com/nhnacademy-be12-trillion/front-server/commit/a9d1cdaf24078d945039312cf0fdd2a1dfe8b689
)